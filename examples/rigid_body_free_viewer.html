
<!DOCTYPE html>
<html>
<head>
    <title>Free Rigid Body (Dzhanibekov Effect)</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; }
        canvas { border: 1px solid #444; }
        .info { margin: 10px; text-align: center; }
    </style>
</head>
<body>
    <h1>Rigid Body Tumbling</h1>
    <p>Yellow axis marks the unstable intermediate axis (Iâ‚‚).</p>
    <p class="info">Using Lie-Poisson mechanics with implicit midpoint integrator.</p>
    <canvas id="simCanvas" width="600" height="600"></canvas>
    <script>
        const history = [[1.0, 0.0, 0.0, 0.0], [0.9997999668121338, 0.00020168500486761332, 0.019998477771878242, 6.832805229350924e-05], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823], [-0.7994723916053772, 0.045362453907728195, 0.5966619849205017, -0.05273285508155823]];
        const I = [1.0, 2.0, 3.0];
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const scale = 100;

        // Box geometry scaled by inertia (larger I = smaller dimension)
        const vertices = [
            [-1, -0.5, -0.2], [1, -0.5, -0.2], [1, 0.5, -0.2], [-1, 0.5, -0.2],
            [-1, -0.5, 0.2], [1, -0.5, 0.2], [1, 0.5, 0.2], [-1, 0.5, 0.2]
        ];

        let frame = 0;

        function rotateByQuat(v, q) {
            const [w, x, y, z] = q;
            const [vx, vy, vz] = v;
            const x2 = x + x, y2 = y + y, z2 = z + z;
            const xx = x * x2, xy = x * y2, xz = x * z2;
            const yy = y * y2, yz = y * z2, zz = z * z2;
            const wx = w * x2, wy = w * y2, wz = w * z2;
            return [
                (1 - (yy + zz)) * vx + (xy - wz) * vy + (xz + wy) * vz,
                (xy + wz) * vx + (1 - (xx + zz)) * vy + (yz - wx) * vz,
                (xz - wy) * vx + (yz + wx) * vy + (1 - (xx + yy)) * vz
            ];
        }

        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const qs = history[frame];
            const show = Array.isArray(qs[0]) ? qs : [qs];
            const grid = Math.ceil(Math.sqrt(show.length));
            show.forEach((q, idx) => {
                const gx = idx % grid;
                const gy = Math.floor(idx / grid);
                const ox = cx + (gx - (grid - 1)/2) * 220;
                const oy = cy + (gy - (grid - 1)/2) * 220;
                const projected = vertices.map(v => {
                    const rot = rotateByQuat(v, q);
                    return [ox + rot[0] * scale, oy + rot[1] * scale];
                });

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                const edges = [
                    [0,1], [1,2], [2,3], [3,0],
                    [4,5], [5,6], [6,7], [7,4],
                    [0,4], [1,5], [2,6], [3,7]
                ];
                ctx.beginPath();
                edges.forEach(e => {
                    ctx.moveTo(projected[e[0]][0], projected[e[0]][1]);
                    ctx.lineTo(projected[e[1]][0], projected[e[1]][1]);
                });
                ctx.stroke();

                const axes = [[1.5, 0, 0], [0, 1.2, 0], [0, 0, 0.8]];
                const colors = ['#f00', '#ff0', '#00f'];
                axes.forEach((axis, i) => {
                    const rot = rotateByQuat(axis, q);
                    ctx.strokeStyle = colors[i];
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(ox, oy);
                    ctx.lineTo(ox + rot[0] * scale, oy + rot[1] * scale);
                    ctx.stroke();
                });
            });

            frame = (frame + 1) % history.length;
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
    