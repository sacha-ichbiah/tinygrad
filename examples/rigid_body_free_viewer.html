
<!DOCTYPE html>
<html>
<head>
    <title>Free Rigid Body (Dzhanibekov Effect)</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; }
        canvas { border: 1px solid #444; }
        .info { margin: 10px; text-align: center; }
    </style>
</head>
<body>
    <h1>Rigid Body Tumbling</h1>
    <p>Yellow axis marks the unstable intermediate axis (Iâ‚‚).</p>
    <p class="info">Using Lie-Poisson mechanics with implicit midpoint integrator.</p>
    <canvas id="simCanvas" width="600" height="600"></canvas>
    <script>
        const history = [[1.0, 0.0, 0.0, 0.0], [0.996801495552063, 0.0007771752425469458, 0.07991424947977066, 0.00024465477326884866], [0.987226128578186, 0.0015104780904948711, 0.15931759774684906, 0.00045015133218839765], [0.9713355302810669, 0.002198866568505764, 0.2377021312713623, 0.0006191161228343844], [0.949230968952179, 0.002841600449755788, 0.3145662844181061, 0.0007533182506449521], [0.9210542440414429, 0.0034381342120468616, 0.3894183337688446, 0.0008537084213458002], [0.8869854211807251, 0.003988005220890045, 0.46177953481674194, 0.000920464051887393], [0.8472424149513245, 0.004490738268941641, 0.5311866998672485, 0.0009530425304546952], [0.802079439163208, 0.00494574848562479, 0.5971961617469788, 0.0009502417524345219], [0.7517856359481812, 0.005352243315428495, 0.6593852043151855, 0.0009102661861106753], [0.6966825723648071, 0.005709140095859766, 0.7173563241958618, 0.0008308006217703223], [0.6371228694915771, 0.006014970596879721, 0.7707385420799255, 0.0007090908475220203], [0.573487401008606, 0.006267806049436331, 0.8191903829574585, 0.000542032066732645], [0.5061832070350647, 0.006465170998126268, 0.8624017238616943, 0.0003262644459027797], [0.4356410503387451, 0.006603967864066362, 0.9000962376594543, 5.827807399327867e-05], [0.36231210827827454, 0.006680402439087629, 0.9320328235626221, -0.0002654742856975645], [0.286665678024292, 0.00668991357088089, 0.9580071568489075, -0.0006484534242190421], [0.209185391664505, 0.006627100985497236, 0.9778529405593872, -0.0010938990162685513], [0.13036714494228363, 0.006485676858574152, 0.9914432764053345, -0.0016046857926994562], [0.05071525275707245, 0.0062583996914327145, 0.9986911416053772, -0.0021831635385751724], [-0.029260629788041115, 0.005937033798545599, 0.9995502233505249, -0.0028309873305261135], [-0.10904872417449951, 0.00551231112331152, 0.9940147995948792, -0.0035489313304424286], [-0.18813838064670563, 0.004973908886313438, 0.9821203351020813, -0.004336688667535782], [-0.2660233676433563, 0.004310437478125095, 0.9639430046081543, -0.005192657932639122], [-0.3422050476074219, 0.0035094423219561577, 0.9395989179611206, -0.00611370662227273], [-0.416195809841156, 0.0025574429892003536, 0.9092437624931335, -0.007094928994774818], [-0.4875217080116272, 0.0014399687061086297, 0.8730719089508057, -0.008129380643367767], [-0.5557258129119873, 0.00014164380263537169, 0.8313145637512207, -0.009207789786159992], [-0.6203712821006775, -0.0013537085615098476, 0.7842392921447754, -0.010318281129002571], [-0.6810435652732849, -0.003062920644879341, 0.7321470379829407, -0.011446037329733372], [-0.7373533248901367, -0.005003299564123154, 0.6753717064857483, -0.012572997249662876], [-0.7889394164085388, -0.00719239329919219, 0.6142767667770386, -0.013677519746124744], [-0.8354701399803162, -0.009647713042795658, 0.5492536425590515, -0.014734026975929737], [-0.8766462802886963, -0.01238639559596777, 0.4807192087173462, -0.01571267656981945], [-0.9122027158737183, -0.015424801968038082, 0.4091130793094635, -0.016578994691371918], [-0.9419097304344177, -0.018778041005134583, 0.3348945081233978, -0.017293555662035942], [-0.9655750393867493, -0.022459419444203377, 0.25854048132896423, -0.017811637371778488], [-0.983044445514679, -0.026479823514819145, 0.1805422157049179, -0.018082913011312485], [-0.9942033290863037, -0.030847009271383286, 0.10140188783407211, -0.018051177263259888], [-0.9989772439002991, -0.03556475043296814, 0.021630005910992622, -0.017654120922088623], [-0.9973325729370117, -0.040631916373968124, -0.058257754892110825, -0.016823137179017067], [-0.9892760515213013, -0.04604146257042885, -0.13774360716342926, -0.01548317726701498], [-0.9748563170433044, -0.05177931860089302, -0.21631082892417908, -0.013552792370319366], [-0.9541624188423157, -0.057823095470666885, -0.2934466600418091, -0.0109441839158535], [-0.9273239374160767, -0.06414064019918442, -0.36864498257637024, -0.007563427090644836], [-0.8945109248161316, -0.0706886574625969, -0.4414094090461731, -0.0033108831848949194], [-0.8559327721595764, -0.077410988509655, -0.5112564563751221, 0.0019182288087904453], [-0.8118371367454529, -0.08423691242933273, -0.5777169466018677, 0.008232993073761463], [-0.7625100016593933, -0.09107936173677444, -0.6403399109840393, 0.01574569009244442], [-0.7082738876342773, -0.09783297777175903, -0.6986939907073975, 0.024570338428020477], [-0.6494874358177185, -0.10437209159135818, -0.7523696422576904, 0.034820858389139175], [-0.5865444540977478, -0.11054889857769012, -0.8009820580482483, 0.046608734875917435], [-0.5198726058006287, -0.11619143187999725, -0.8441725373268127, 0.060040153563022614], [-0.4499335289001465, -0.12110187858343124, -0.881610631942749, 0.07521256804466248], [-0.37722182273864746, -0.12505502998828888, -0.9129962921142578, 0.09221047163009644], [-0.3022650480270386, -0.12779715657234192, -0.9380620718002319, 0.11110033094882965], [-0.22562333941459656, -0.1290454864501953, -0.9565758109092712, 0.1319247931241989], [-0.14788967370986938, -0.12848863005638123, -0.9683432579040527, 0.1546957790851593], [-0.06968984007835388, -0.12578780949115753, -0.9732117652893066, 0.17938654124736786], [0.008317461237311363, -0.12058005481958389, -0.971075177192688, 0.20592300593852997], [0.08544102311134338, -0.11248299479484558, -0.9618784189224243, 0.23417386412620544], [0.16095827519893646, -0.1011023223400116, -0.945624828338623, 0.2639405429363251], [0.23411762714385986, -0.08604203164577484, -0.9223840832710266, 0.2949463129043579], [0.3041433095932007, -0.06691817939281464, -0.8923020362854004, 0.32682695984840393], [0.3702423572540283, -0.04337634891271591, -0.855611264705658, 0.35912182927131653], [0.4316161572933197, -0.01511278748512268, -0.8126426339149475, 0.3912685215473175], [0.4874767065048218, 0.018100878223776817, -0.7638368606567383, 0.42260172963142395], [0.5370674133300781, 0.0563906691968441, -0.7097543478012085, 0.45235762000083923], [0.579691469669342, 0.09975265711545944, -0.6510814428329468, 0.47968772053718567], [0.6147419214248657, 0.14802706241607666, -0.5886311531066895, 0.5036800503730774], [0.6417384147644043, 0.20087771117687225, -0.52333664894104, 0.5233916640281677], [0.6603611707687378, 0.2577803134918213, -0.45623278617858887, 0.5378885269165039], [0.6704836487770081, 0.318022221326828, -0.38842856884002686, 0.5462936758995056], [0.6721938848495483, 0.3807169795036316, -0.32106879353523254, 0.5478365421295166], [0.6658059358596802, 0.44483307003974915, -0.2552873194217682, 0.5418988466262817], [0.6518531441688538, 0.5092358589172363, -0.19215644896030426, 0.5280552506446838], [0.6310662627220154, 0.5727372765541077, -0.13263845443725586, 0.5060973763465881], [0.6043357849121094, 0.6341506242752075, -0.07754351198673248, 0.4760443866252899], [0.5726636648178101, 0.6923418641090393, -0.027499787509441376, 0.4381357431411743], [0.5371098518371582, 0.7462722659111023, 0.017062362283468246, 0.39280980825424194], [0.49873948097229004, 0.7950318455696106, 0.05591106042265892, 0.34067198634147644], [0.4585753083229065, 0.8378580808639526, 0.08900032937526703, 0.28245627880096436], [0.41756072640419006, 0.8741442561149597, 0.11644742637872696, 0.218986377120018], [0.3765329420566559, 0.9034360647201538, 0.138503760099411, 0.15113885700702667], [0.33620792627334595, 0.9254226088523865, 0.15552332997322083, 0.07981132715940475], [0.2971746623516083, 0.9399210214614868, 0.1679317206144333, 0.005897673778235912], [0.259897917509079, 0.9468606114387512, 0.17619791626930237, -0.0697309598326683], [0.22472608089447021, 0.9462664127349854, 0.18081022799015045, -0.14623892307281494], [0.19190312922000885, 0.938243567943573, 0.18225660920143127, -0.22283384203910828], [0.1615821123123169, 0.9229639172554016, 0.1810101866722107, -0.2987712025642395], [0.13383902609348297, 0.9006553888320923, 0.17751839756965637, -0.373355507850647], [0.10868669301271439, 0.8715919852256775, 0.17219598591327667, -0.44594085216522217], [0.08608696609735489, 0.8360872864723206, 0.16542083024978638, -0.5159292817115784], [0.06596215069293976, 0.7944883108139038, 0.15753185749053955, -0.5827702283859253], [0.04820476099848747, 0.7471712827682495, 0.14882908761501312, -0.6459575891494751], [0.03268575295805931, 0.6945380568504333, 0.13957448303699493, -0.7050302624702454], [0.01926150918006897, 0.6370129585266113, 0.12999385595321655, -0.759568989276886], [0.007779577746987343, 0.575040876865387, 0.12027928233146667, -0.8091973662376404], [-0.0019167393911629915, 0.5090845227241516, 0.11059167236089706, -0.8535800576210022], [-0.009984675794839859, 0.43962225317955017, 0.10106372833251953, -0.8924230337142944], [-0.01657911203801632, 0.3671465218067169, 0.09180271625518799, -0.9254733920097351], [-0.021850354969501495, 0.29216092824935913, 0.08289329707622528, -0.9525194764137268], [-0.025942487642169, 0.21517866849899292, 0.07440030574798584, -0.9733909368515015], [-0.02899213321506977, 0.13671977818012238, 0.06637102365493774, -0.9879586100578308], [-0.031127693131566048, 0.05730852857232094, 0.058837756514549255, -0.9961349964141846], [-0.03246881067752838, -0.02252880670130253, 0.05181995779275894, -0.9978742003440857], [-0.03312608599662781, -0.10226684808731079, 0.04532606154680252, -0.9931715726852417], [-0.03320105001330376, -0.18138381838798523, 0.03935542330145836, -0.9820635318756104], [-0.032786302268505096, -0.25936445593833923, 0.03389985114336014, -0.9646273851394653], [-0.03196563571691513, -0.33570271730422974, 0.028945060446858406, -0.9409803748130798], [-0.030814476311206818, -0.4099046587944031, 0.024471964687108994, -0.9112792015075684], [-0.029400156810879707, -0.48149144649505615, 0.02045774832367897, -0.8757185935974121], [-0.027782458811998367, -0.5500020384788513, 0.016876893118023872, -0.8345304131507874], [-0.02601402997970581, -0.6149960160255432, 0.013702009804546833, -0.7879818677902222], [-0.02414087951183319, -0.6760557293891907, 0.010904569178819656, -0.7363741993904114], [-0.02220289409160614, -0.7327895760536194, 0.008455542847514153, -0.6800405383110046], [-0.02023433893918991, -0.7848339080810547, 0.006325896829366684, -0.6193435192108154], [-0.018264353275299072, -0.8318553566932678, 0.00448705954477191, -0.5546737909317017], [-0.016317421570420265, -0.8735530972480774, 0.0029112575575709343, -0.48644670844078064], [-0.014413842931389809, -0.9096599817276001, 0.0015718196518719196, -0.4151005148887634], [-0.012570178136229515, -0.9399454593658447, 0.00044339796295389533, -0.34109294414520264], [-0.010799655690789223, -0.9642157554626465, -0.0004978673532605171, -0.2648984491825104], [-0.009112565778195858, -0.9823158383369446, -0.001274219946935773, -0.18700531125068665], [-0.007516638841480017, -0.9941301941871643, -0.0019062089268118143, -0.10791262239217758], [-0.0060173748061060905, -0.99958336353302, -0.0024126418866217136, -0.02812693826854229], [-0.004618358798325062, -0.9986407160758972, -0.002810574835166335, 0.05184075981378555]];
        const I = [1.0, 2.0, 3.0];
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const scale = 100;

        // Box geometry scaled by inertia (larger I = smaller dimension)
        const vertices = [
            [-1, -0.5, -0.2], [1, -0.5, -0.2], [1, 0.5, -0.2], [-1, 0.5, -0.2],
            [-1, -0.5, 0.2], [1, -0.5, 0.2], [1, 0.5, 0.2], [-1, 0.5, 0.2]
        ];

        let frame = 0;

        function rotateByQuat(v, q) {
            const [w, x, y, z] = q;
            const [vx, vy, vz] = v;
            const x2 = x + x, y2 = y + y, z2 = z + z;
            const xx = x * x2, xy = x * y2, xz = x * z2;
            const yy = y * y2, yz = y * z2, zz = z * z2;
            const wx = w * x2, wy = w * y2, wz = w * z2;
            return [
                (1 - (yy + zz)) * vx + (xy - wz) * vy + (xz + wy) * vz,
                (xy + wz) * vx + (1 - (xx + zz)) * vy + (yz - wx) * vz,
                (xz - wy) * vx + (yz + wx) * vy + (1 - (xx + yy)) * vz
            ];
        }

        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const qs = history[frame];
            const show = Array.isArray(qs[0]) ? qs : [qs];
            const grid = Math.ceil(Math.sqrt(show.length));
            show.forEach((q, idx) => {
                const gx = idx % grid;
                const gy = Math.floor(idx / grid);
                const ox = cx + (gx - (grid - 1)/2) * 220;
                const oy = cy + (gy - (grid - 1)/2) * 220;
                const projected = vertices.map(v => {
                    const rot = rotateByQuat(v, q);
                    return [ox + rot[0] * scale, oy + rot[1] * scale];
                });

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                const edges = [
                    [0,1], [1,2], [2,3], [3,0],
                    [4,5], [5,6], [6,7], [7,4],
                    [0,4], [1,5], [2,6], [3,7]
                ];
                ctx.beginPath();
                edges.forEach(e => {
                    ctx.moveTo(projected[e[0]][0], projected[e[0]][1]);
                    ctx.lineTo(projected[e[1]][0], projected[e[1]][1]);
                });
                ctx.stroke();

                const axes = [[1.5, 0, 0], [0, 1.2, 0], [0, 0, 0.8]];
                const colors = ['#f00', '#ff0', '#00f'];
                axes.forEach((axis, i) => {
                    const rot = rotateByQuat(axis, q);
                    ctx.strokeStyle = colors[i];
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(ox, oy);
                    ctx.lineTo(ox + rot[0] * scale, oy + rot[1] * scale);
                    ctx.stroke();
                });
            });

            frame = (frame + 1) % history.length;
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
    