
<!DOCTYPE html>
<html>
<head>
    <title>Free Rigid Body (Dzhanibekov Effect)</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; }
        canvas { border: 1px solid #444; }
        .info { margin: 10px; text-align: center; }
    </style>
</head>
<body>
    <h1>Rigid Body Tumbling</h1>
    <p>Yellow axis marks the unstable intermediate axis (Iâ‚‚).</p>
    <p class="info">Using Lie-Poisson mechanics with implicit midpoint integrator.</p>
    <canvas id="simCanvas" width="600" height="600"></canvas>
    <script>
        const history = [[1.0, 0.0, 0.0, 0.0], [0.9992000460624695, 0.00039399138768203557, 0.03998906537890434, 0.0001274206006200984], [0.996801495552063, 0.0007771752425469458, 0.07991424947977066, 0.00024465477326884866], [0.9928079843521118, 0.001149384188465774, 0.11971164494752884, 0.00035211321664974093], [0.987226128578186, 0.0015104780904948711, 0.15931759774684906, 0.00045015133218839765], [0.980064868927002, 0.0018603389617055655, 0.19866876304149628, 0.0005390699370764196], [0.9713355302810669, 0.002198866568505764, 0.2377021312713623, 0.0006191160646267235], [0.9610520601272583, 0.0025259777903556824, 0.27635523676872253, 0.0006904843030497432], [0.949230968952179, 0.002841600449755788, 0.3145662844181061, 0.0007533181342296302], [0.9358912706375122, 0.0031456719152629375, 0.352274090051651, 0.0008077110396698117], [0.9210542440414429, 0.0034381342120468616, 0.3894183337688446, 0.0008537082467228174], [0.904743492603302, 0.003718930296599865, 0.4259396493434906, 0.0008913078927434981], [0.8869854211807251, 0.003988005220890045, 0.46177953481674194, 0.0009204638190567493], [0.8678081035614014, 0.004245296586304903, 0.49688059091567993, 0.0009410856291651726], [0.8472424149513245, 0.004490738268941641, 0.5311866998672485, 0.0009530422394163907], [0.8253211379051208, 0.004724252503365278, 0.5646430850028992, 0.0009561632759869099], [0.802079439163208, 0.00494574848562479, 0.5971961617469788, 0.0009502412867732346], [0.7775545716285706, 0.0051551200449466705, 0.6287937164306641, 0.0009350335458293557], [0.7517856359481812, 0.005352243315428495, 0.6593852043151855, 0.0009102653129957616], [0.7248139381408691, 0.005536973010748625, 0.6889218688011169, 0.0008756316383369267], [0.6966825723648071, 0.005709140095859766, 0.7173563241958618, 0.000830799457617104], [0.6674366593360901, 0.0058685471303761005, 0.7446430921554565, 0.0007754118414595723], [0.6371228694915771, 0.006014970596879721, 0.7707385420799255, 0.0007090893341228366], [0.6057897210121155, 0.00614815391600132, 0.7956008911132812, 0.0006314335041679442], [0.573487401008606, 0.006267806515097618, 0.8191903829574585, 0.0005420301458798349], [0.5402674674987793, 0.006373599637299776, 0.8414690494537354, 0.0004404517821967602], [0.5061832070350647, 0.006465171463787556, 0.8624017238616943, 0.00032626200118102133], [0.47128915786743164, 0.006542110349982977, 0.8819544911384583, 0.00019901810446754098], [0.4356410503387451, 0.00660396832972765, 0.9000962376594543, 5.827508357469924e-05], [0.39929598569869995, 0.006650247611105442, 0.9167979955673218, -9.64108548942022e-05], [0.36231210827827454, 0.006680402904748917, 0.9320328235626221, -0.0002654779818840325], [0.3247486352920532, 0.006693840026855469, 0.9457765221595764, -0.00044935522601008415], [0.286665678024292, 0.006689914036542177, 0.9580071568489075, -0.0006484578480012715], [0.24812404811382294, 0.006667919456958771, 0.9687049984931946, -0.0008631826494820416], [0.209185391664505, 0.0066271014511585236, 0.9778529405593872, -0.0010939041385427117], [0.1699121743440628, 0.006566645577549934, 0.9854364395141602, -0.0013409694656729698], [0.13036714494228363, 0.006485677324235439, 0.9914432764053345, -0.0016046918462961912], [0.09061364829540253, 0.006383262109011412, 0.9958639740943909, -0.0018853482324630022], [0.05071525275707245, 0.006258400157094002, 0.9986911416053772, -0.0021831709891557693], [0.010735834017395973, 0.006110033486038446, 0.9999206066131592, -0.0024983438197523355], [-0.029260629788041115, 0.005937034264206886, 0.9995502233505249, -0.0028309959452599287], [-0.06921013444662094, 0.005738214123994112, 0.9975805878639221, -0.0031811953522264957], [-0.10904872417449951, 0.005512311588972807, 0.9940147995948792, -0.003548941109329462], [-0.1487126499414444, 0.005258006975054741, 0.988858699798584, -0.003934161271899939], [-0.18813838064670563, 0.004973908886313438, 0.9821203351020813, -0.00433669937774539], [-0.22726282477378845, 0.004658559802919626, 0.9738106727600098, -0.004756314679980278], [-0.2660233676433563, 0.004310436546802521, 0.9639430046081543, -0.005192670505493879], [-0.3043578863143921, 0.003927947953343391, 0.952532947063446, -0.005645322147756815], [-0.3422050476074219, 0.003509441390633583, 0.9395989179611206, -0.006113721523433924], [-0.37950432300567627, 0.0030531990341842175, 0.9251614809036255, -0.006597196217626333], [-0.416195809841156, 0.0025574408937245607, 0.9092437624931335, -0.007094947155565023], [-0.4522208571434021, 0.0020203287713229656, 0.8918712735176086, -0.007606041617691517], [-0.4875217080116272, 0.0014399659121409059, 0.8730719089508057, -0.008129401132464409], [-0.5220417380332947, 0.0008144029998220503, 0.8528756499290466, -0.008663789369165897], [-0.5557258129119873, 0.00014163969899527729, 0.8313145637512207, -0.009207812137901783], [-0.588519811630249, -0.0005803701933473349, 0.808423638343811, -0.009759902022778988], [-0.6203712821006775, -0.0013537144986912608, 0.7842392921447754, -0.010318305343389511], [-0.6512290239334106, -0.0021805164869874716, 0.7588001489639282, -0.010881073772907257], [-0.6810435652732849, -0.0030629290267825127, 0.7321470379829407, -0.011446064338088036], [-0.7097670435905457, -0.0040031298995018005, 0.7043226957321167, -0.012010909616947174], [-0.7373533248901367, -0.005003311205655336, 0.6753717064857483, -0.012573027051985264], [-0.7637583017349243, -0.006065671797841787, 0.6453403234481812, -0.013129595667123795], [-0.7889394164085388, -0.007192409131675959, 0.6142767667770386, -0.013677552342414856], [-0.812856137752533, -0.008385705761611462, 0.5822306871414185, -0.014213568530976772], [-0.8354701399803162, -0.00964773166924715, 0.5492536425590515, -0.014734061434864998], [-0.8567450046539307, -0.010980609804391861, 0.515398383140564, -0.01523516234010458], [-0.8766462802886963, -0.012386420741677284, 0.4807192087173462, -0.015712711960077286], [-0.895142138004303, -0.013867183588445187, 0.44527187943458557, -0.016162259504199028], [-0.9122027158737183, -0.01542483177036047, 0.4091130793094635, -0.01657903753221035], [-0.9278002977371216, -0.01706121675670147, 0.3723009526729584, -0.016957955434918404], [-0.9419097304344177, -0.01877807453274727, 0.3348945081233978, -0.017293598502874374], [-0.9545081853866577, -0.020577002316713333, 0.2969540059566498, -0.01758021116256714], [-0.9655750393867493, -0.02245945855975151, 0.25854048132896423, -0.01781168021261692], [-0.975092351436615, -0.024426719173789024, 0.21971571445465088, -0.01798154041171074], [-0.983044445514679, -0.026479870080947876, 0.1805422008037567, -0.018082953989505768], [-0.9894183278083801, -0.028619782999157906, 0.14108304679393768, -0.018108708783984184], [-0.9942033290863037, -0.03084706701338291, 0.10140187293291092, -0.01805121824145317], [-0.9973915815353394, -0.03316206485033035, 0.06156272813677788, -0.017902493476867676], [-0.9989772439002991, -0.03556482493877411, 0.02162998355925083, -0.017654160037636757], [-0.9989577531814575, -0.038055017590522766, -0.018331756815314293, -0.017297446727752686], [-0.9973325729370117, -0.04063199833035469, -0.058257780969142914, -0.016823170706629753], [-0.994103729724884, -0.04329467937350273, -0.09808330237865448, -0.016221744939684868], [-0.9892760515213013, -0.04604155570268631, -0.13774363696575165, -0.015483202412724495], [-0.9828571081161499, -0.04887064918875694, -0.17717428505420685, -0.01459715235978365], [-0.9748563170433044, -0.051779426634311676, -0.21631087362766266, -0.013552810065448284], [-0.9652864933013916, -0.054764844477176666, -0.25508955121040344, -0.012339009903371334], [-0.9541624188423157, -0.05782320350408554, -0.29344671964645386, -0.010944190435111523], [-0.9415014386177063, -0.060950182378292084, -0.3313193619251251, -0.009356423281133175], [-0.9273238778114319, -0.06414075195789337, -0.3686450123786926, -0.007563421968370676], [-0.9116520881652832, -0.06738915294408798, -0.405362069606781, -0.005552553106099367], [-0.8945109248161316, -0.07068877667188644, -0.44140946865081787, -0.003310861997306347], [-0.8759279251098633, -0.07403222471475601, -0.47672733664512634, -0.000825095979962498], [-0.8559327125549316, -0.07741112262010574, -0.5112564563751221, 0.0019182701362296939], [-0.8345575928688049, -0.08081617206335068, -0.5449385643005371, 0.004933001007884741], [-0.8118371367454529, -0.08423706889152527, -0.5777168869972229, 0.008233061991631985], [-0.7878082394599915, -0.08766237646341324, -0.6095355153083801, 0.011832577176392078], [-0.7625100016593933, -0.09107954800128937, -0.6403398513793945, 0.01574578694999218], [-0.7359840273857117, -0.09447482973337173, -0.6700766086578369, 0.019986990839242935], [-0.7082739472389221, -0.09783320128917694, -0.6986939311027527, 0.024570481851696968], [-0.6794255971908569, -0.10113828629255295, -0.7261412739753723, 0.02951047196984291], [-0.6494874358177185, -0.10437235981225967, -0.7523696422576904, 0.0348210372030735], [-0.6185095310211182, -0.10751620680093765, -0.7773318290710449, 0.040516022592782974], [-0.5865443348884583, -0.11054916679859161, -0.8009821176528931, 0.04660895839333534], [-0.553646445274353, -0.11344896256923676, -0.8232764005661011, 0.05311290919780731], [-0.5198724865913391, -0.11619171500205994, -0.8441725373268127, 0.060040418058633804], [-0.48528122901916504, -0.11875186860561371, -0.8636301159858704, 0.0674033910036087], [-0.44993340969085693, -0.12110216915607452, -0.881610631942749, 0.07521287351846695], [-0.41389185190200806, -0.12321359664201736, -0.8980774879455566, 0.08347902446985245], [-0.3772217035293579, -0.12505532801151276, -0.9129962921142578, 0.09221082925796509], [-0.33998972177505493, -0.12659476697444916, -0.9263344407081604, 0.10141600668430328], [-0.3022649586200714, -0.127797469496727, -0.9380620718002319, 0.11110078543424606], [-0.2641184329986572, -0.12862715125083923, -0.9481509923934937, 0.12126968055963516], [-0.22562319040298462, -0.12904581427574158, -0.9565757513046265, 0.1319252997636795], [-0.1868545114994049, -0.1290135383605957, -0.9633132219314575, 0.14306814968585968], [-0.14788955450057983, -0.1284889429807663, -0.9683430790901184, 0.15469634532928467], [-0.1088075190782547, -0.12742869555950165, -0.9716475009918213, 0.16680525243282318], [-0.06968973577022552, -0.125788152217865, -0.9732117056846619, 0.17938730120658875], [-0.03061956912279129, -0.12352114915847778, -0.9730237126350403, 0.19243161380290985], [0.008317575789988041, -0.12058039754629135, -0.9710749983787537, 0.2059238851070404], [0.04703427851200104, -0.11691749095916748, -0.9673603177070618, 0.2198457568883896], [0.08544113487005234, -0.11248331516981125, -0.9618781805038452, 0.23417480289936066], [0.12344685941934586, -0.10722827166318893, -0.9546306729316711, 0.24888400733470917], [0.16095834970474243, -0.10110261291265488, -0.9456244707107544, 0.26394152641296387], [0.19788073003292084, -0.0940568596124649, -0.934870183467865, 0.2793101668357849], [0.23411771655082703, -0.08604228496551514, -0.922383725643158, 0.2949475347995758], [0.2695715129375458, -0.0770113542675972, -0.9081854820251465, 0.31080490350723267], [0.30414336919784546, -0.06691838800907135, -0.892301619052887, 0.3268281817436218], [0.33773359656333923, -0.05572012811899185, -0.8747640252113342, 0.34295663237571716], [0.37024229764938354, -0.04337647929787636, -0.8556107878684998, 0.3591231107711792], [0.40156954526901245, -0.029851220548152924, -0.8348863124847412, 0.37525424361228943], [0.43161600828170776, -0.015112836845219135, -0.8126420974731445, 0.39126989245414734], [0.46028369665145874, 0.0008646720671094954, -0.7889366745948792, 0.4070836901664734], [0.4874764084815979, 0.018100911751389503, -0.7638362050056458, 0.4226031005382538], [0.513100802898407, 0.03660822659730911, -0.7374146580696106, 0.43772950768470764], [0.537067174911499, 0.05639079958200455, -0.709753692150116, 0.45235905051231384], [0.5592904686927795, 0.07744386792182922, -0.6809430122375488, 0.4663831293582916], [0.5796911120414734, 0.09975285828113556, -0.6510806083679199, 0.4796890318393707], [0.5981964468955994, 0.12329275906085968, -0.6202719807624817, 0.4921611249446869], [0.6147416234016418, 0.14802737534046173, -0.5886302590370178, 0.5036814212799072], [0.6292707324028015, 0.1739090532064438, -0.5562759637832642, 0.5141314268112183], [0.6417379379272461, 0.20087817311286926, -0.5233356952667236, 0.5233930349349976], [0.6521087288856506, 0.2288631945848465, -0.4899418354034424, 0.5313499569892883], [0.6603606343269348, 0.2577808201313019, -0.4562317430973053, 0.537889838218689], [0.6664840579032898, 0.28753602504730225, -0.42234596610069275, 0.5429050326347351], [0.6704830527305603, 0.31802284717559814, -0.38842761516571045, 0.5462948083877563], [0.6723753809928894, 0.3491252064704895, -0.35462045669555664, 0.5479666590690613], [0.6721932291984558, 0.3807176947593689, -0.32106783986091614, 0.5478373765945435], [0.6699830889701843, 0.4126671850681305, -0.2879107892513275, 0.545835018157959], [0.6658051609992981, 0.4448338449001312, -0.25528639554977417, 0.5418996214866638], [0.6597329378128052, 0.4770730435848236, -0.2233264297246933, 0.535984218120575], [0.6518522500991821, 0.5092366337776184, -0.19215558469295502, 0.5280556678771973], [0.6422606110572815, 0.5411748886108398, -0.1618904322385788, 0.5180952548980713], [0.631065309047699, 0.5727380514144897, -0.13263769447803497, 0.5060977935791016], [0.6183823347091675, 0.6037784814834595, -0.10449360311031342, 0.492073118686676], [0.6043347716331482, 0.6341514587402344, -0.07754285633563995, 0.4760447144508362], [0.5890509486198425, 0.6637173295021057, -0.05185804143548012, 0.4580492079257965], [0.5726626515388489, 0.6923426389694214, -0.027499239891767502, 0.43813592195510864], [0.5553039312362671, 0.7199005484580994, -0.004513952881097794, 0.41636571288108826], [0.5371087789535522, 0.7462730407714844, 0.017062827944755554, 0.3928098678588867], [0.5182102918624878, 0.7713503837585449, 0.03720832243561745, 0.3675490915775299], [0.4987384080886841, 0.7950323820114136, 0.05591144040226936, 0.3406718969345093], [0.4788194000720978, 0.8172287940979004, 0.07317214459180832, 0.3122739791870117], [0.4585743844509125, 0.8378586173057556, 0.0890006497502327, 0.2824562191963196], [0.43811842799186707, 0.8568509817123413, 0.10341648757457733, 0.25132402777671814], [0.4175599217414856, 0.8741444945335388, 0.11644762009382248, 0.21898621320724487], [0.3970000445842743, 0.8896874189376831, 0.1281294971704483, 0.1855536848306656], [0.37653231620788574, 0.9034363627433777, 0.13850390911102295, 0.15113860368728638], [0.35624226927757263, 0.9153570532798767, 0.14761799573898315, 0.11585359275341034], [0.33620741963386536, 0.925422728061676, 0.1555234044790268, 0.07981100678443909], [0.31649747490882874, 0.9336147904396057, 0.16227535903453827, 0.043122269213199615], [0.29717424511909485, 0.9399210214614868, 0.1679316908121109, 0.005897308234125376], [0.2782919704914093, 0.9443362355232239, 0.1725522130727768, -0.03175583481788635], [0.25989753007888794, 0.9468607306480408, 0.176197811961174, -0.06973136216402054], [0.2420310229063034, 0.947500467300415, 0.17892998456954956, -0.10792604833841324], [0.22472581267356873, 0.9462664723396301, 0.18081006407737732, -0.14623934030532837], [0.20800916850566864, 0.9431741833686829, 0.18189886212348938, -0.18457357585430145], [0.19190287590026855, 0.9382434487342834, 0.18225638568401337, -0.22283421456813812], [0.17642329633235931, 0.9314976930618286, 0.18194110691547394, -0.260929673910141], [0.16158196330070496, 0.9229637980461121, 0.1810099482536316, -0.29877153038978577], [0.14738614857196808, 0.9126720428466797, 0.1795179545879364, -0.3362743556499481], [0.13383907079696655, 0.9006552696228027, 0.17751812934875488, -0.3733558654785156], [0.1209404394030571, 0.8869491815567017, 0.17506122589111328, -0.4099368453025818], [0.10868682712316513, 0.8715918660163879, 0.1721956729888916, -0.44594115018844604], [0.09707198292016983, 0.8546237349510193, 0.16896754503250122, -0.48129552602767944], [0.0860871747136116, 0.8360871076583862, 0.16542045772075653, -0.5159295797348022], [0.07572156935930252, 0.816026508808136, 0.16159553825855255, -0.5497762560844421], [0.06596243381500244, 0.7944881319999695, 0.1575314849615097, -0.582770586013794], [0.05679548531770706, 0.7715197801589966, 0.153264582157135, -0.6148508191108704], [0.04820510372519493, 0.7471711039543152, 0.14882871508598328, -0.6459580063819885], [0.040174536406993866, 0.7214928865432739, 0.14425544440746307, -0.6760358214378357], [0.03268613666296005, 0.6945377588272095, 0.1395740658044815, -0.7050304412841797], [0.02572157233953476, 0.6663593053817749, 0.13481180369853973, -0.7328912019729614], [0.019261933863162994, 0.6370127201080322, 0.1299935132265091, -0.7595692873001099], [0.013287939131259918, 0.6065540313720703, 0.12514223158359528, -0.7850192189216614], [0.007780036889016628, 0.5750406384468079, 0.1202789694070816, -0.8091976642608643], [0.002718542004004121, 0.54253089427948, 0.11542285233736038, -0.8320639133453369], [-0.0019162549870088696, 0.509084165096283, 0.1105913445353508, -0.8535801768302917], [-0.006143996492028236, 0.47476089000701904, 0.10580016672611237, -0.8737109303474426], [-0.009984172880649567, 0.43962201476097107, 0.10106342285871506, -0.8924230933189392], [-0.01345604844391346, 0.4037295877933502, 0.09639380127191544, -0.9096865057945251], [-0.01657859981060028, 0.3671463131904602, 0.0918024554848671, -0.9254735112190247], [-0.01937044970691204, 0.32993531227111816, 0.08729933202266693, -0.9397586584091187], [-0.02184983529150486, 0.29216068983078003, 0.08289308845996857, -0.9525195956230164], [-0.024034563452005386, 0.25388672947883606, 0.07859119772911072, -0.9637361168861389], [-0.025941967964172363, 0.215178444981575, 0.07440011203289032, -0.9733909368515015], [-0.02758888341486454, 0.17610089480876923, 0.07032518088817596, -0.9814692139625549], [-0.028991634026169777, 0.13671953976154327, 0.0663708746433258, -0.9879586100578308], [-0.03016599640250206, 0.09710007160902023, 0.06254078447818756, -0.992849588394165], [-0.03112722374498844, 0.057308293879032135, 0.05883768945932388, -0.9961351156234741], [-0.03188997134566307, 0.017410002648830414, 0.05526360869407654, -0.9978104829788208], [-0.03246837109327316, -0.022529028356075287, 0.051819946616888046, -0.9978742599487305], [-0.032875943928956985, -0.062443166971206665, 0.04850737750530243, -0.9963268041610718], [-0.03312567621469498, -0.10226704180240631, 0.045326098799705505, -0.9931715130805969], [-0.033229973167181015, -0.1419355422258377, 0.04227576032280922, -0.9884143471717834], [-0.03320068120956421, -0.18138401210308075, 0.039355527609586716, -0.9820634722709656], [-0.03304910287261009, -0.22054822742938995, 0.03656415641307831, -0.9741299748420715], [-0.03278597816824913, -0.25936460494995117, 0.033900026232004166, -0.9646273255348206], [-0.03242151066660881, -0.297770231962204, 0.0313611663877964, -0.9535713195800781], [-0.031965382397174835, -0.33570289611816406, 0.028945311903953552, -0.9409803152084351], [-0.03142675757408142, -0.37310123443603516, 0.026649940758943558, -0.9268752336502075], [-0.030814295634627342, -0.4099048972129822, 0.024472292512655258, -0.9112791419029236], [-0.030136164277791977, -0.4460543990135193, 0.022409407421946526, -0.8942175507545471], [-0.029400069266557693, -0.48149168491363525, 0.02045815996825695, -0.8757185339927673], [-0.028613243252038956, -0.5161595940589905, 0.01861528493463993, -0.8558120131492615], [-0.027782481163740158, -0.5500022768974304, 0.016877394169569016, -0.8345302939414978], [-0.026914134621620178, -0.5829655528068542, 0.015241014771163464, -0.811907947063446], [-0.026014162227511406, -0.6149962544441223, 0.013702602125704288, -0.7879817485809326], [-0.025088107213377953, -0.6460429430007935, 0.012258559465408325, -0.7627902030944824], [-0.024141132831573486, -0.6760559678077698, 0.010905258357524872, -0.7363739609718323], [-0.02317804843187332, -0.7049869894981384, 0.009639060124754906, -0.7087759375572205], [-0.022203290835022926, -0.7327896952629089, 0.008456321433186531, -0.6800404191017151], [-0.021220974624156952, -0.7594196200370789, 0.007353420834988356, -0.6502134203910828], [-0.02023489959537983, -0.7848339676856995, 0.0063267662189900875, -0.6193434000015259], [-0.019248541444540024, -0.8089922070503235, 0.005372797138988972, -0.5874797105789185], [-0.018265090882778168, -0.8318554162979126, 0.004488013219088316, -0.5546736121177673], [-0.01728747971355915, -0.8533872365951538, 0.0036689697299152613, -0.5209778547286987], [-0.016318362206220627, -0.8735530972480774, 0.0029122934211045504, -0.4864465296268463], [-0.015360144898295403, -0.8923207521438599, 0.0022146853152662516, -0.45113518834114075], [-0.014415004290640354, -0.9096600413322449, 0.0015729308361187577, -0.4151003062725067], [-0.013484903611242771, -0.925543487071991, 0.0009839044651016593, -0.37839990854263306], [-0.01257158163934946, -0.9399455785751343, 0.00044457337935455143, -0.34109270572662354], [-0.011676597408950329, -0.952843189239502, -4.79973568872083e-05, -0.3032386004924774], [-0.01080131996423006, -0.9642158150672913, -0.0004966413252986968, -0.2648982107639313], [-0.009946946054697037, -0.9740452170372009, -0.0009040880249813199, -0.22613298892974854], [-0.009114515967667103, -0.9823158383369446, -0.001272960682399571, -0.18700505793094635], [-0.008304916322231293, -0.9890144467353821, -0.0016057748580351472, -0.14757715165615082], [-0.007518898695707321, -0.9941301941871643, -0.0019049369730055332, -0.10791237652301788], [-0.006757080554962158, -0.9976550340652466, -0.0021727439016103745, -0.0680742859840393], [-0.006019965745508671, -0.99958336353302, -0.002411383204162121, -0.028126707300543785], [-0.005307944491505623, -0.9999121427536011, -0.002622932894155383, 0.011866397224366665], [-0.004621306899935007, -0.9986407160758972, -0.0028093603905290365, 0.05184098333120346]];
        const I = [1.0, 2.0, 3.0];
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const scale = 100;

        // Box geometry scaled by inertia (larger I = smaller dimension)
        const vertices = [
            [-1, -0.5, -0.2], [1, -0.5, -0.2], [1, 0.5, -0.2], [-1, 0.5, -0.2],
            [-1, -0.5, 0.2], [1, -0.5, 0.2], [1, 0.5, 0.2], [-1, 0.5, 0.2]
        ];

        let frame = 0;

        function rotateByQuat(v, q) {
            const [w, x, y, z] = q;
            const [vx, vy, vz] = v;
            const x2 = x + x, y2 = y + y, z2 = z + z;
            const xx = x * x2, xy = x * y2, xz = x * z2;
            const yy = y * y2, yz = y * z2, zz = z * z2;
            const wx = w * x2, wy = w * y2, wz = w * z2;
            return [
                (1 - (yy + zz)) * vx + (xy - wz) * vy + (xz + wy) * vz,
                (xy + wz) * vx + (1 - (xx + zz)) * vy + (yz - wx) * vz,
                (xz - wy) * vx + (yz + wx) * vy + (1 - (xx + yy)) * vz
            ];
        }

        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const qs = history[frame];
            const show = Array.isArray(qs[0]) ? qs : [qs];
            const grid = Math.ceil(Math.sqrt(show.length));
            show.forEach((q, idx) => {
                const gx = idx % grid;
                const gy = Math.floor(idx / grid);
                const ox = cx + (gx - (grid - 1)/2) * 220;
                const oy = cy + (gy - (grid - 1)/2) * 220;
                const projected = vertices.map(v => {
                    const rot = rotateByQuat(v, q);
                    return [ox + rot[0] * scale, oy + rot[1] * scale];
                });

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                const edges = [
                    [0,1], [1,2], [2,3], [3,0],
                    [4,5], [5,6], [6,7], [7,4],
                    [0,4], [1,5], [2,6], [3,7]
                ];
                ctx.beginPath();
                edges.forEach(e => {
                    ctx.moveTo(projected[e[0]][0], projected[e[0]][1]);
                    ctx.lineTo(projected[e[1]][0], projected[e[1]][1]);
                });
                ctx.stroke();

                const axes = [[1.5, 0, 0], [0, 1.2, 0], [0, 0, 0.8]];
                const colors = ['#f00', '#ff0', '#00f'];
                axes.forEach((axis, i) => {
                    const rot = rotateByQuat(axis, q);
                    ctx.strokeStyle = colors[i];
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(ox, oy);
                    ctx.lineTo(ox + rot[0] * scale, oy + rot[1] * scale);
                    ctx.stroke();
                });
            });

            frame = (frame + 1) % history.length;
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
    